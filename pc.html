<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table Recorder PC</title>
    <style>
        :root {
            --bg: #1a1c1e; --card-bg: #2d2f31; --border: #444; --text: #f0f0f0;
            --accent: #4f46e5; --atk-bg: #4a1d1d; --crit-bg: #1d2d4a; --elem-bg: #301d4a; --sharp-bg: #4a441d;
            --atk-border: #ff4d4d; --crit-border: #3399ff; --elem-border: #b366ff; --sharp-border: #ffd700;
            --gold-bg: #d4af37; --highlight: rgba(255, 255, 255, 0.15);
        }
        body { font-family: 'Segoe UI', Meiryo, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 1250px; display: flex; flex-direction: column; gap: 15px; }

        .tab-group { display: flex; gap: 5px; width: 100%; }
        .tab-btn { background: #333; color: #888; border: none; padding: 12px 25px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: bold; }
        .tab-btn.active { background: var(--card-bg); color: var(--text); border: 1px solid var(--border); border-bottom: none; }

        .config-panel { background: var(--card-bg); padding: 15px; border-radius: 0 12px 12px 12px; border: 1px solid var(--border); }
        .setup-row { display: grid; grid-template-columns: 1fr 1fr 0.6fr 0.8fr; gap: 10px; margin-bottom: 15px; }
        select { background: #3d3f41; color: white; border: 1px solid #555; padding: 10px; border-radius: 6px; outline: none; }

        .status-and-calc { display: grid; grid-template-columns: 1fr 1.8fr; gap: 20px; border-top: 1px solid #444; padding-top: 15px; }
        .status-display { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .buffer-preview { display: flex; gap: 8px; height: 40px; align-items: center; justify-content: center; }
        .preview-item { background: #1a1c1e; border: 1px solid #555; width: 85px; height: 32px; line-height: 32px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; text-align: center; }

        .calc-permanent-ui { display: grid; grid-template-columns: 1fr auto; gap: 15px; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; border: 1px solid #444; }
        .input-columns { display: flex; flex-direction: column; gap: 8px; }
        .parts-header-labels { display: grid; grid-template-columns: 80px 1fr 1fr 1fr; gap: 8px; text-align: center; }
        .parts-header-labels span { font-size: 0.7rem; color: var(--accent); font-weight: bold; }
        .calc-line { display: grid; grid-template-columns: 80px 1fr 1fr 1fr; gap: 8px; align-items: center; }
        .calc-line label { font-size: 0.75rem; color: #aaa; font-weight: bold; }
        .calc-line input { background: #111; color: #fff; border: 1px solid #555; padding: 8px; border-radius: 4px; text-align: center; font-weight: bold; width: 100%; box-sizing: border-box; }
        .copy-row { display: grid; grid-template-columns: 80px 1fr; gap: 8px; }
        .copy-arrow-btn { background: #444; color: #fff; border: 1px solid #666; border-radius: 4px; padding: 2px 0; cursor: pointer; font-size: 0.7rem; font-weight: bold; width: 100%; }

        .est-rd-box { min-width: 110px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-left: 2px solid #444; padding-left: 15px; }
        .est-rd-val { font-size: 2rem; font-weight: bold; color: var(--gold-bg); line-height: 1; }

        .view-content { display: none; }
        .view-content.active { display: block; }
        .input-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .category-box { position: relative; border-radius: 12px; padding: 35px 12px 12px 12px; border: 2px solid #555; text-align: center; }
        .cat-tag { position: absolute; top: 8px; left: 12px; font-size: 0.75rem; font-weight: bold; opacity: 0.8; letter-spacing: 1px; }
        .btn-group { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .btn { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.3); padding: 30px 0; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.4rem; }
        .r-ex { background: var(--gold-bg); color: #000; border-color: #fff; }

        .skill-line { background: #36383a; padding: 20px; border-radius: 10px; display: flex; align-items: center; gap: 20px; margin-bottom: 10px; }
        .ox-btn { padding: 15px 40px; border-radius: 8px; border: 1px solid #555; cursor: pointer; font-weight: bold; background: #3d3f41; color: #fff; font-size: 1.2rem; }
        .ox-btn.selected-o { background: var(--accent); border-color: #fff; }
        .skill-sel { flex: 1; padding: 12px; background: #222; color: #fff; border-radius: 6px; display: none; font-size: 1.1rem; }

        .log-section { margin-top: 20px; width: 100%; }
        .log-header-tools { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; }
        .table-container { background: var(--card-bg); border-radius: 12px; overflow-x: auto; border: 1px solid var(--border); scroll-behavior: smooth; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; table-layout: fixed; }
        th, td { padding: 12px; text-align: center; border: 1px solid #333; width: 110px; min-width: 110px; }
        th { background: #36383a; color: #aaa; cursor: pointer; }
        .weapon-name-cell { background: #111; text-align: left; font-weight: bold; color: var(--accent); width: 180px; min-width: 180px; position: sticky; left: 0; z-index: 20; border-right: 2px solid #444; }
        
        .gold-highlight { background: var(--gold-bg) !important; color: #000 !important; font-weight: bold; }
        .col-highlight { background-color: var(--highlight) !important; }
        .col-header-active { background: var(--accent) !important; color: white !important; }

        .fill-btn { background: #ff9800; color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .cur-rd-disp { background: #111; color: var(--accent); border: 1px solid var(--accent); border-radius: 6px; padding: 8px; width: 60px; text-align: center; font-weight: bold; font-size: 1.1rem; }
        .clear-btn { background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 15px; width: 800px; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <div class="tab-group">
        <button id="tab-btn-normal" class="tab-btn active" onclick="switchView('normal')">通常抽選</button>
        <button id="tab-btn-skill" class="tab-btn" onclick="switchView('skill')">スキル抽選</button>
        <button class="tab-btn" style="margin-left:auto; font-size:0.8rem;" onclick="openModal('settingsModal')">スキル管理</button>
    </div>

    <div class="config-panel">
        <div class="setup-row">
            <select id="catSelect"></select><select id="elemSelect"></select>
            <select id="numSelect"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
            <select id="gekikaType" onchange="calcRound();">
                <option value="atk">激化：攻撃</option><option value="crit">激化：会心</option><option value="elem">激化：属性</option>
            </select>
        </div>

        <div class="status-and-calc">
            <div class="status-display">
                <div id="curWeaponDisp" style="font-weight:bold; color:#888; font-size: 0.8rem; margin-bottom:5px;">READY</div>
                <div class="buffer-preview" id="previewArea"></div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button style="background:none; border:1px solid #555; color:#888; cursor:pointer; padding:5px 15px; border-radius:4px;" onclick="addAllX()">すべて×</button>
                    <button style="background:none; border:1px solid #555; color:#888; cursor:pointer; padding:5px 15px; border-radius:4px;" onclick="undo()">Undo</button>
                </div>
            </div>

            <div class="calc-permanent-ui">
                <div class="input-columns">
                    <div class="parts-header-labels">
                        <span>区分</span><span>攻撃パーツ</span><span>会心パーツ</span><span>属性パーツ</span>
                    </div>
                    <div class="calc-line">
                        <label>確認前</label>
                        <input type="number" id="preAtk" oninput="calcRound()">
                        <input type="number" id="preCrit" oninput="calcRound()">
                        <input type="number" id="preElem" oninput="calcRound()">
                    </div>
                    <div class="copy-row">
                        <span></span>
                        <button class="copy-arrow-btn" onclick="copyPartsToCurrent()">▼ 確認前を「現在残り」にコピー ▼</button>
                    </div>
                    <div class="calc-line">
                        <label>現在残り</label>
                        <input type="number" id="curAtk" oninput="calcRound()">
                        <input type="number" id="curCrit" oninput="calcRound()">
                        <input type="number" id="curElem" oninput="calcRound()">
                    </div>
                </div>
                <div class="est-rd-box">
                    <span style="font-size: 0.65rem; color:#888; margin-bottom:5px;">推定現在Rd</span>
                    <div id="resRd" class="est-rd-val">1</div>
                    <div id="resErr" style="color:#ff5252; font-size:0.6rem; font-weight:bold; margin-top:5px; text-align:center;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-normal" class="view-content active">
        <div class="input-grid">
            <div class="category-box" style="background:var(--atk-bg); border-color:var(--atk-border);"><span class="cat-tag">攻撃</span><div class="btn-group"><button class="btn" onclick="addValue('攻Ⅰ')">Ⅰ</button><button class="btn" onclick="addValue('攻Ⅱ')">Ⅱ</button><button class="btn" onclick="addValue('攻Ⅲ')">Ⅲ</button><button class="btn r-ex" onclick="addValue('攻EX')">EX</button></div></div>
            <div class="category-box" style="background:var(--crit-bg); border-color:var(--crit-border);"><span class="cat-tag">会心</span><div class="btn-group"><button class="btn" onclick="addValue('会Ⅰ')">Ⅰ</button><button class="btn" onclick="addValue('会Ⅱ')">Ⅱ</button><button class="btn" onclick="addValue('会Ⅲ')">Ⅲ</button><button class="btn r-ex" onclick="addValue('会EX')">EX</button></div></div>
            <div class="category-box" style="background:var(--elem-bg); border-color:var(--elem-border);"><span class="cat-tag">属性</span><div class="btn-group"><button class="btn" onclick="addValue('属Ⅰ')">Ⅰ</button><button class="btn" onclick="addValue('属Ⅱ')">Ⅱ</button><button class="btn" onclick="addValue('属Ⅲ')">Ⅲ</button><button class="btn r-ex" onclick="addValue('属EX')">EX</button></div></div>
            <div class="category-box" style="background:var(--sharp-bg); border-color:var(--sharp-border);"><span class="cat-tag">斬/数</span><div class="btn-group"><button class="btn" onclick="addValue('斬Ⅰ')">Ⅰ</button><button class="btn" onclick="addValue('斬Ⅱ')">Ⅱ</button><button class="btn" onclick="addValue('斬Ⅲ')">Ⅲ</button><button class="btn r-ex" onclick="addValue('斬EX')">EX</button></div></div>
        </div>
    </div>

    <div id="view-skill" class="view-content">
        <div class="skill-line">
            <div style="min-width:100px; font-weight:bold;">抽選 1</div>
            <div class="ox-group"><button class="ox-btn" id="s1-o" onclick="setSkillStatus(1, '○')">○</button><button class="ox-btn" id="s1-x" onclick="setSkillStatus(1, '×')">×</button></div>
            <select id="skill1Select" class="skill-sel" style="display:none; margin-left:20px; padding:10px;" onchange="updateSkillPreview(1)"></select>
        </div>
        <div class="skill-line">
            <div style="min-width:100px; font-weight:bold;">抽選 2</div>
            <div class="ox-group"><button class="ox-btn" id="s2-o" onclick="setSkillStatus(2, '○')">○</button><button class="ox-btn" id="s2-x" onclick="setSkillStatus(2, '×')">×</button></div>
            <select id="skill2Select" class="skill-sel" style="display:none; margin-left:20px; padding:10px;" onchange="updateSkillPreview(2)"></select>
        </div>
    </div>

    <div class="log-section">
        <div class="log-header-tools">
            <h3 style="margin:0;">履歴</h3>
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:0.8rem; color:#aaa;">Rd:</span>
                <input type="number" id="curRoundInput" class="cur-rd-disp" value="1" onchange="manualSetRound(this.value)">
                <button class="fill-btn" id="fillBtn" onclick="autoFillX()">推定前まで全て×で埋める</button>
            </div>
            <div class="action-bar">
                <button class="clear-btn" onclick="clearAllData()">全消去</button>
                <button style="background:#5c5ce6; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold;" onclick="copyToClipboard()">SS保存(.txt)</button>
                <button style="background:#10b981; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold;" onclick="triggerFileLoad()">SSファイル読込</button>
                <input type="file" id="fileInput" style="display:none;" accept=".txt" onchange="loadFromFile(event)">
            </div>
        </div>
        <div id="tableContainer" class="table-container">
            <div id="norm-table-wrap"><table><thead><tr id="head-normal"></tr></thead><tbody id="body-normal"></tbody></table></div>
            <div id="skill-table-wrap" style="display:none;"><table><thead><tr id="head-skill"></tr></thead><tbody id="body-skill"></tbody></table></div>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal"><div class="modal-content"><h3>スキル管理</h3><div id="editorArea" style="display:grid; grid-template-columns:1fr 1fr; gap:20px;"></div><button class="tab-btn" style="margin-top:20px; width:100%; border-radius:8px;" onclick="closeModal('settingsModal')">設定を閉じる</button></div></div>

<script>
    const elemColors = {"無":"#aaa","火":"#f44","水":"#39f","雷":"#fd0","氷":"#4ed","龍":"#e00","毒":"#d4f","麻痺":"#fc0","睡眠":"#0ce","爆破":"#f80"};
    
    const MASTER_SKILLS_1 = ["闢獣の力（力自慢）", "火竜の力（灼熱化）", "兇爪竜の力（連撃強化）", "護鎖刃竜の命脈（破壊衝動）", "波衣竜の守護（守護のヴェール）", "煌雷竜の力（雷々響鳴）", "雷顎竜の闘志（無尽蔵）", "雪獅子の闘志（ウォークライ）", "鎧竜の守護（無傷の重装）", "凍峰竜の反逆（束縛反攻）", "暗器蛸の力（蛮勇の食卓）", "獄焔蛸の反逆（恨撃）", "黒蝕竜の力（黒蝕一体）", "鎖刃竜の飢餓（加速再生）", "泡狐竜の力（泡沫の舞）", "白熾龍の脈動（超回復力）", "花舞の祈り（地の恵み）", "千刃竜の闘志（千刃の身躱し）", "海竜の渦雷（蒼雷一閃）", "踊火の祈り（地の恵み）", "暗黒騎士の証（ダークアーツ）", "オメガレゾナンス", "夢灯の祈り（地の恵み）", "巨戟龍の黙示録（宣戦呼応）"];
    const MASTER_SKILLS_2 = ["鱗張りの技法（乗り名人）", "革細工の柔性（採集の達人）", "毛皮の昂揚（不屈）", "甲虫の知らせ（ハニーハンター）", "護竜の脈動（竜乳活性）", "ヌシの誇り（激励）", "甲虫の擬態（忍び歩き）", "革細工の滑性（滑走強化）", "鱗重ねの工夫（奮起）", "毛皮の誘惑（陽動）", "護竜の守り（竜都の護り）", "ヌシの憤激（死中に活）", "先達の導き（探索者の幸運）", "栄光の誉れ（幸運）", "祝祭の巡り（剥ぎ取り名人）", "ヌシの魂（根性【果敢】）", "拳を極めし者（殺意の波動）"];

    let skillEnabledMap = {}; 
    let dataNormal = {}, dataSkill = {}, currentBuffer = [], activeMode = 'normal', globalActiveColIdx = 1, estimatedRd = 1;

    window.onload = function() {
        const catS = document.getElementById('catSelect'); const eleS = document.getElementById('elemSelect');
        ["大剣","太刀","片手剣","双剣","ハンマー","狩猟笛","スラアク","チャアク","ランス","ガンランス","操虫棍","弓","Lボウガン","Hボウガン"].forEach(v => catS.add(new Option(v, v)));
        ["無","火","水","雷","氷","龍","毒","麻痺","睡眠","爆破"].forEach(v => eleS.add(new Option(v, v)));
        catS.onchange = eleS.onchange = document.getElementById('numSelect').onchange = () => { updateUI(); renderTable(); };
        loadFromCache(); switchView('normal'); refreshSkillDropdowns(); calcRound();
    };

    function saveCache() {
        localStorage.setItem('table_pc_stable_v1', JSON.stringify({
            dataNormal, dataSkill, skillEnabledMap, globalActiveColIdx,
            gekika: document.getElementById('gekikaType').value,
            pre: [document.getElementById('preAtk').value, document.getElementById('preCrit').value, document.getElementById('preElem').value],
            cur: [document.getElementById('curAtk').value, document.getElementById('curCrit').value, document.getElementById('curElem').value]
        }));
    }

    function loadFromCache() {
        const cache = localStorage.getItem('table_pc_stable_v1');
        if (cache) {
            const p = JSON.parse(cache);
            dataNormal = p.dataNormal || {}; dataSkill = p.dataSkill || {};
            skillEnabledMap = p.skillEnabledMap || {}; globalActiveColIdx = p.globalActiveColIdx || 1;
            document.getElementById('curRoundInput').value = globalActiveColIdx;
            if(p.gekika) document.getElementById('gekikaType').value = p.gekika;
            if(p.pre) { document.getElementById('preAtk').value=p.pre[0]; document.getElementById('preCrit').value=p.pre[1]; document.getElementById('preElem').value=p.pre[2]; }
            if(p.cur) { document.getElementById('curAtk').value=p.cur[0]; document.getElementById('curCrit').value=p.cur[1]; document.getElementById('curElem').value=p.cur[2]; }
        } else {
            const on1 = ["兇爪","護鎖","波衣","煌雷","雷顎","凍峰","獄焔","黒蝕","鎖刃","泡狐","白熾","千刃","海竜","暗黒騎士","オメガ","巨戟"];
            MASTER_SKILLS_1.forEach(s => { if (on1.some(k => s.includes(k))) skillEnabledMap[s] = true; });
            skillEnabledMap["ヌシの魂（根性【果敢】）"] = true;
        }
    }

    function calcRound() {
        const type = document.getElementById('gekikaType').value;
        const pre = [parseInt(document.getElementById('preAtk').value), parseInt(document.getElementById('preCrit').value), parseInt(document.getElementById('preElem').value)];
        const cur = [parseInt(document.getElementById('curAtk').value), parseInt(document.getElementById('curCrit').value), parseInt(document.getElementById('curElem').value)];
        if (pre.every(v => isNaN(v)) && cur.every(v => isNaN(v))) return;
        let diff = [(pre[0]||0)-(cur[0]||0), (pre[1]||0)-(cur[1]||0), (pre[2]||0)-(cur[2]||0)];
        if(type === 'atk') diff[0] *= 2; if(type === 'crit') diff[1] *= 2; if(type === 'elem') diff[2] *= 2;
        const sum = diff[0] + diff[1] + diff[2];
        const resEl = document.getElementById('resRd'); const errEl = document.getElementById('resErr');
        if(sum >= 0 && sum % 6 === 0) {
            estimatedRd = (sum / 6) + 1; resEl.innerText = estimatedRd; errEl.innerText = "";
            globalActiveColIdx = estimatedRd; document.getElementById('curRoundInput').value = estimatedRd; renderTable();
        } else { estimatedRd = 0; resEl.innerText = "???"; errEl.innerText = "異常"; }
        saveCache();
    }

    function saveRound() {
        const id = getWId(); const t = (activeMode === 'normal' ? dataNormal : dataSkill);
        if(!t[id]) t[id] = [];
        t[id][globalActiveColIdx-1] = [...currentBuffer];
        currentBuffer = []; resetSkillUI();
        globalActiveColIdx++; document.getElementById('curRoundInput').value = globalActiveColIdx;
        updateUI(); renderTable(); saveCache(); autoScroll();
    }

    function addValue(val) {
        const max = (activeMode === 'normal' ? 5 : 2);
        if(currentBuffer.length < max) {
            currentBuffer.push(val); updateUI();
            if(currentBuffer.length === max) {
                saveRound();
            }
        }
    }

    function renderTable() {
        const targetData = (activeMode === 'normal' ? dataNormal : dataSkill);
        const maxR = Object.values(targetData).reduce((max, arr) => Math.max(max, arr.length), 0);
        const currentLimit = Math.max(maxR, globalActiveColIdx);
        const body = document.getElementById(activeMode === 'normal' ? 'body-normal' : 'body-skill');
        const head = document.getElementById(activeMode === 'normal' ? 'head-normal' : 'head-skill');
        const rows = (activeMode === 'normal' ? 5 : 2); const curW = getWId();
        
        head.innerHTML = '<th class="weapon-name-cell">武器名</th>';
        for(let i=1; i<=currentLimit; i++) {
            const th = document.createElement('th'); th.innerText = `Rd.${i}`;
            if(i === globalActiveColIdx) th.classList.add('col-header-active');
            th.onclick = () => { globalActiveColIdx = i; document.getElementById('curRoundInput').value = i; renderTable(); saveCache(); };
            head.appendChild(th);
        }
        body.innerHTML = '';
        Object.keys(targetData).sort((a,b) => (a===curW?-1:b===curW?1:a.localeCompare(b))).forEach(id => {
            const color = elemColors[id.split('-')[1]] || "#eee";
            for(let i=0; i<rows; i++){
                const tr = document.createElement('tr'); if(i===rows-1) tr.style.borderBottom="2px solid #444";
                if(i===0) tr.innerHTML = `<td class="weapon-name-cell" rowspan="${rows}" style="color:${color}">${id}</td>`;
                for(let r=1; r<=currentLimit; r++){
                    const val = targetData[id][r-1] ? targetData[id][r-1][i] : "";
                    const td = document.createElement('td'); 
                    td.innerText = (val||"").replace(/（.*?）/g, "");
                    if(val && ((activeMode==='normal' && (val.includes('EX') || val.includes('攻') || val.includes('会') || val.includes('属') || val.includes('斬'))) || (activeMode==='skill' && val!=='×' && val !== ""))) {
                        if(val.includes('EX') || activeMode==='skill') td.classList.add('gold-highlight');
                    }
                    if(r === globalActiveColIdx) td.classList.add('col-highlight');
                    tr.appendChild(td);
                } body.appendChild(tr);
            }
        });
    }

    function triggerFileLoad() { document.getElementById('fileInput').click(); }
    function loadFromFile(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => { processSSData(e.target.result); event.target.value = ''; };
        reader.readAsText(file);
    }
    function processSSData(text) {
        if(!text.trim()) return;
        const rows = text.split(/\r?\n/); let importData = activeMode === 'normal' ? dataNormal : dataSkill;
        const slots = activeMode === 'normal' ? 5 : 2;
        let tempStore = {}, currentId = "", currentSubRow = 0;
        try {
            for(let line of rows) {
                if(!line.trim()) continue; const cols = line.split('\t');
                if(cols.length < 2) continue;
                if(cols[0]) { currentId = cols[0].trim(); currentSubRow = 0; }
                if(!currentId) continue; if(!tempStore[currentId]) tempStore[currentId] = [];
                for(let r=0; r < cols.length - 1; r++) {
                    if(!tempStore[currentId][r]) tempStore[currentId][r] = new Array(slots).fill("");
                    if(currentSubRow < slots) tempStore[currentId][r][currentSubRow] = cols[r+1].trim();
                }
                currentSubRow++;
            }
            Object.assign(importData, tempStore); renderTable(); saveCache(); alert("読込完了");
        } catch (err) { alert("読込エラー"); }
    }

    function copyPartsToCurrent() {
        document.getElementById('curAtk').value = document.getElementById('preAtk').value;
        document.getElementById('curCrit').value = document.getElementById('preCrit').value;
        document.getElementById('curElem').value = document.getElementById('preElem').value;
        calcRound();
    }
    function switchView(mode) {
        activeMode = mode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === 'tab-btn-' + mode));
        document.getElementById('view-normal').style.display = (mode === 'normal' ? 'block' : 'none');
        document.getElementById('view-skill').style.display = (mode === 'skill' ? 'block' : 'none');
        document.getElementById('norm-table-wrap').style.display = (mode === 'normal' ? 'block' : 'none');
        document.getElementById('skill-table-wrap').style.display = (mode === 'skill' ? 'block' : 'none');
        const area = document.getElementById('previewArea'); area.innerHTML = '';
        for(let i=0; i<(mode==='normal'?5:2); i++) {
            const div = document.createElement('div'); div.className = 'preview-item'; div.id = 'prev-' + i; area.appendChild(div);
        }
        currentBuffer = []; updateUI(); renderTable();
    }
    function addAllX() { currentBuffer = (activeMode === 'normal' ? ['×','×','×','×','×'] : ['×','×']); saveRound(); }
    function getWId() { return document.getElementById('catSelect').value + "-" + document.getElementById('elemSelect').value + "-" + document.getElementById('numSelect').value; }
    function manualSetRound(val) { globalActiveColIdx = parseInt(val)||1; renderTable(); saveCache(); autoScroll(); }
    function autoScroll() { const container = document.getElementById('tableContainer'); if(globalActiveColIdx > 1) container.scrollLeft = (globalActiveColIdx-1)*110; }
    function updateUI() {
        document.getElementById('curWeaponDisp').innerText = getWId();
        for(let i=0; i<(activeMode==='normal'?5:2); i++) { const el = document.getElementById('prev-' + i); if(el) el.innerText = (currentBuffer[i]||"").replace(/（.*?）/g, ""); }
    }
    function undo() {
        if(currentBuffer.length > 0) currentBuffer.pop();
        else if(globalActiveColIdx > 1) {
            globalActiveColIdx--; document.getElementById('curRoundInput').value = globalActiveColIdx;
            const t = (activeMode === 'normal' ? dataNormal : dataSkill);
            if(t[getWId()]) t[getWId()][globalActiveColIdx-1] = (activeMode==='normal'?["","","","",""]:["",""]);
        }
        updateUI(); renderTable(); saveCache();
    }
    function resetSkillUI() { document.querySelectorAll('.ox-btn').forEach(b => b.classList.remove('selected-o')); document.querySelectorAll('.skill-sel').forEach(s => s.style.display = 'none'); }
    function setSkillStatus(slot, s) {
        const oBtn = document.getElementById('s'+slot+'-o'); const xBtn = document.getElementById('s'+slot+'-x');
        oBtn.classList.toggle('selected-o', s==='○'); xBtn.classList.toggle('selected-o', s==='×');
        const sel = document.getElementById('skill'+slot+'Select'); sel.style.display = (s==='○'?'block':'none');
        currentBuffer[slot-1] = (s==='×'?'×':sel.value); updateUI();
        if(currentBuffer.length === 2 && currentBuffer[0] && currentBuffer[1]) saveRound();
    }
    function updateSkillPreview(slot) { if(document.getElementById('s'+slot+'-o').classList.contains('selected-o')) { currentBuffer[slot-1] = document.getElementById('skill'+slot+'Select').value; updateUI(); if(currentBuffer.length === 2 && currentBuffer[0] && currentBuffer[1]) saveRound(); } }
    function refreshSkillDropdowns() {
        const s1 = document.getElementById('skill1Select'); const s2 = document.getElementById('skill2Select');
        s1.innerHTML = ''; s2.innerHTML = '';
        MASTER_SKILLS_1.filter(s => skillEnabledMap[s]).forEach(s => s1.add(new Option(s, s)));
        MASTER_SKILLS_2.filter(s => skillEnabledMap[s]).forEach(s => s2.add(new Option(s, s)));
    }
    function autoFillX() {
        if(estimatedRd <= 1) return alert("逆算Rd不足");
        const id = getWId(); const t = (activeMode === 'normal' ? dataNormal : dataSkill);
        const xData = (activeMode === 'normal' ? ['×','×','×','×','×'] : ['×','×']);
        if(!t[id]) t[id] = [];
        for(let i=0; i < estimatedRd-1; i++) if(!t[id][i] || t[id][i].every(v=>v==="")) t[id][i] = [...xData];
        renderTable(); saveCache();
    }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; if(id==='settingsModal') renderSettings(); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function renderSettings() {
        const area = document.getElementById('editorArea'); area.innerHTML = '';
        [MASTER_SKILLS_1, MASTER_SKILLS_2].forEach((list, idx) => {
            const div = document.createElement('div'); div.innerHTML = `<b>リスト ${idx+1}</b><br><br>`;
            list.forEach(s => { const opt = document.createElement('div'); opt.style.marginBottom="5px"; opt.innerHTML = `<input type="checkbox" ${skillEnabledMap[s]?'checked':''} onchange="skillEnabledMap['${s}']=this.checked; saveCache(); refreshSkillDropdowns();"> <span style="font-size:0.8rem">${s}</span>`; div.appendChild(opt); });
            area.appendChild(div);
        });
    }
    function clearAllData() { if(confirm("消去？")) { dataNormal={}; dataSkill={}; saveCache(); renderTable(); } }
    function copyToClipboard() {
        const t = (activeMode === 'normal' ? dataNormal : dataSkill); let tsv = ""; 
        Object.keys(t).sort().forEach(id => {
            const maxR = Object.values(t).reduce((max, arr) => Math.max(max, arr.length), 0);
            for(let i=0; i<(activeMode==='normal'?5:2); i++){
                tsv += (i === 0 ? id : "") + "\t";
                for(let r=0; r<maxR; r++) tsv += (t[id][r] ? t[id][r][i] : "") + "\t";
                tsv += "\n";
            }
        });
        const blob = new Blob([tsv], {type: 'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'TableData.txt'; a.click();
    }
</script>
</body>
</html>